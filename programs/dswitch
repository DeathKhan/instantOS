#!/bin/bash

##############################################
## dwm popup to choose between open windows ##
## does not change to respective monitor    ##
##############################################

if ! [ -n "$1" ]; then

    num=$(wmctrl -l | sed 's/  / /' | cut -d " " -f 4- | nl -w 3 -n rn | sed -r 's/^([ 0-9]+)[ \t]*(.*)$/\1 - \2/' |
        rofi -dmenu -i -me-select-entry '' -me-accept-entry 'MousePrimary' -kb-row-down 'Alt+Tab,Down' -kb-row-up 'Alt+Ctrl+Tab,Up' -kb-accept-entry '!Alt_L,!Alt+Tab,Return' | cut -d '-' -f -1)
    [[ -z "$num" ]] && exit

    WID=$(wmctrl -l | sed -n "$num p" | cut -c -10)
else
    WID="$1"
fi

echo "focus target $WID"

hex() {
    echo "0x0$(printf '%x\n' $1)"
}

pfw() {
    if command pfw | grep -q '0x000001e1'; then
        echo "0x000001e1"
        return
    else
        hex "$(xdotool getactivewindow)"
    fi
}

focuswin() {
    [[ $1 =~ "," ]] && echo "error focussing" && return 1
    wmctrl -i -a "$1"
}

if ! [ -e ~/paperbenni/ismultimonitor ]; then
    focuswin "$WID"
    echo "exiting"
    exit
fi

getmonitor() {
    xdotool key 'super+W'
    XPOS=$(xdotool getmouselocation --shell | head -1 | grep -o '[0-9]*')
    if [ "$XPOS" -gt "1919" ]; then
        echo "1"
    else
        echo "0"
    fi
}

wincomp() {
    NEW=$(echo "$1" | sed 's/^0x0*//g')
    COMP=$(echo "$2" | sed 's/^0x0*//g')
    echo "NEW $NEW COMP $COMP"
    if [ "$NEW" = "$COMP" ]; then
        return 0
    else
        return 1
    fi
}

wincomp "$WID" "$(pfw)" && exit

OLD="$(pfw)"
OLDM="$(getmonitor)"

focuswin "$WID"

if ! wincomp "$(pfw)" "$WID"; then
    if ! [ "$OLDM" = "$(getmonitor)" ]; then
        if ! [ "$OLD" = "0x000001e1" ]; then
            xdotool key 'super+comma'
            focuswin "$OLD"
            xdotool key 'super+comma'
        fi
        focuswin "$WID"
    else
        focuswin "$OLD"
        xdotool key 'super+comma'
        focuswin "$WID"
    fi
else
    if ! [ "$OLD" = "0x000001e1" ]; then
        if ! [ "$OLDM" = "$(getmonitor)" ]; then
            xdotool key 'super+comma'
            focuswin "$OLD"
            xdotool key 'super+comma'
        fi
    fi
fi

xdotool key 'super+W'
